@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using Model;
@model Model.PageInfo<tb_FileInfo>
@Styles.Render("~/Content/style/FileManager.css")
<div id="div_menu">
    <ul id="div_menu_ul">
        <li id="li_file">
            <h4 id="h-file"><span id="span_file"></span>文件浏览</h4>
            <div id="card-file" class="card">
                <span class="throbber-loader">
                    Loading...
                </span>
            </div>
            <div id="divlist-file" class="li_div">
                <ul id="li-div-ul"></ul>
            </div>
        </li>
        <li id="li_map">
            <h4 id="h-map"><span id="span_map"></span>地图管理</h4>
            <div id="card-map" class="card">
                <span class="throbber-loader">
                    Loading...
                </span>
            </div>
            <div id="divlist-map" class="li_div">
                <a>第一名</a>
                <a>第二名</a>
                <a>第三名</a>
            </div>
        </li>
    </ul>
</div>

<div id="div-filemanager">
    @Html.Action("GetFileView")
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel" style="color:white">
                    上传文件
                </h4>
            </div>
            <form id="fileForm">
                <div class="modal-body">
                    <table>
                        <tr>
                            <td style="width:80px;">选择文件：</td>
                            <td colspan="3"><input id="input_file" type="file" name="file" /></td>
                        </tr>
                        <tr>
                            <td>坐标信息框架：</td>
                            <td>
                                <span>
                                    <select id="CoodinateSystem"></select>
                                </span>
                            </td>
                            <td>完成时间信息：</td>
                            <td><input type="date" name="FinishtimeInfo" id="finishtimeinfo" /></td>
                        </tr>
                        <tr>
                            <td>完成人信息：</td>
                            <td><input maxlength="50" name="FinishPersonInfo" id="finishpersoninfo" /></td>
                            <td>最小坐标：</td>
                            <td><input type="number" name="MinCoodinate" id="mincoodinate" /></td>
                        </tr>
                        <tr>
                            <td>最大坐标：</td>
                            <td><input type="number" name="MaxCoodinate" id="maxcoodinate" /></td>
                            <td>文件中对象数量：</td>
                            <td><input type="number" name="ObjectNum" id="objectnum" /></td>
                        </tr>
                        <tr>
                            <td>备注信息：</td>
                            <td colspan="3" style="width:100%;max-width:100%;"><textarea style="width:96%;min-width:96%;" name="Mark" id="mark"></textarea></td>
                        </tr>
                        <tr>
                            <td>是否需要进库：</td>
                            <td>
                                <span>
                                    是：
                                    <input style="width:auto;height:auto;" type="radio" name="Warehousing" value="true" />
                                    否：
                                    <input style="width:auto;height:auto;" type="radio" checked="checked" name="Warehousing" value="false" />
                                </span>
                            </td>
                            <td>所属项目名称：</td>
                            <td><input name="ProjectName" id="projectname" /></td>

                        </tr>
                        <tr>
                            <td>文件类型：</td>
                            <td>
                                <span>
                                    <select id="filetype"></select>
                                </span>
                            </td>
                            <td>所属项目类型：</td>
                            <td>
                                <span>
                                    <select id="projecttype"></select>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>平面坐标系统：</td>
                            <td>
                                <span>
                                    <select id="pcoodinateSystem">
                                    </select>
                                </span>
                            </td>
                            <td>中央子午线：</td>
                            <td><input maxlength="50" name="CenterMeridian" id="centermeridian" /></td>
                        </tr>
                        <tr>
                            <td>纵坐标偏移值：</td>
                            <td><input type="number" name="Yoffset" id="yoffset" /></td>
                            <td>水平坐标偏移值：</td>
                            <td><input type="number" name="Xoffset" id="xoffset" /></td>
                        </tr>
                        <tr>
                            <td>完成时间：</td>
                            <td><input type="date" name="Finishtime" id="finishtime" value="" /></td>
                            <td>完成人名称：</td>
                            <td><input maxlength="50" name="FinishPerson" id="finishperson" /></td>
                        </tr>
                        <tr>
                            <td>成果说明：</td>
                            <td colspan="3"><textarea style="max-width:96%;width:96%;" name="Explain" id="explain"></textarea></td>

                        </tr>
                        <tr>
                            <td>选择公开对象：</td>
                            <td>
                                <span>
                                <select id="selectObjs" class="js-example-basic-multiple" multiple="multiple">
                                </select>
                                </span>
                            </td>
                            <td>测绘单位名称：</td>
                            <td>
                                <span>
                                    <select id="surveyingunitname">
                                    </select>
                                </span>
                            </td>
                        </tr>
                    </table>

                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0"
                         aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                        99%
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" onclick="submitInfo()" class="btn btn-primary">
                        提交
                    </button>
                </div>
            </form>
            <iframe style="display:none" name="fileFrame" id="fileFrame"></iframe>
        </div><!-- /.modal-content -->
    </div>
</div>
<script type="text/javascript">
    var currentAjax = null;
    $(document).ready(function () {
        //加载分类
        $.ajax({
            url: "/FileManager/GetSelectedCategory",
            type: "get",
            dataType: "json",
            async: false,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    var text = "<li><a class='classheader' onclick= 'clickheader(this)'>" + data[i].kind + "</a><ul class='subclass' style='display:none'><li>";
                    for (var j = 0; j < data[i].nodes.length; j++) {
                        text += "<a onclick= 'clickclass(this)'>" + data[i].nodes[j] + "</a>";
                    }
                    text += "</li></ul ></li >";
                    $("#li-div-ul").append(text);
                }
            }
        });
        //设置下拉选项的数据
        $(function setSelectData() {
            var uniturl = "/Droplist/Unitlist";
            var filetypeurl = "/Droplist/FiltTypelist";
            var projecttypeurl = "/Droplist/ProjectTypelist";
            var coodurl = "/Droplist/CoodinateSystemlist";
            getDropData("CoodinateSystem", coodurl);
            getDropData("filetype", filetypeurl);
            getDropData("projecttype", projecttypeurl);
            getDropData("pcoodinateSystem", coodurl);
            getDropData("selectObjs", uniturl);
            getDropData("surveyingunitname", uniturl);
            $(".js-example-basic-multiple").select2();
            //$("#surveyingunitname").val("苏仙区测绘队");
            //清除缓存
            sessionStorage.clear();
        });
    });
    //获取下拉菜单数据
    function getDropData(id,url) {
        //获取文件数据
        $.ajax({
            url: url,
            type: "get",
            dataType: "json",
            success: function (data) {
                //这里是ajax提交成功后，程序返回的数据处理函数。data是返回的数据，数据类型在dataType参数里定义！
                var text = "";
                for (var i = 0; i < data.length; i++) {
                    text += "<option value=" + data[i].Value + ">" + data[i].Value + "</option>";
                }
                $("#" + id).append(text);
            }
        });
    };
    function uploadFile() {
        var dialogwdith = $(window).width() + $(".modal-dialog").width();
        $(".modal-content").css({
            left: (dialogwdith - $(".modal-content").width()) / 2,
        });
        $(".progress-bar").css("width", "0%");
        $(".progress-bar").html("");

        $(".js-example-basic-multiple").select2().val(["市局测绘队","苏仙区测绘队"]).trigger("change");

        //$("#surveyingunitname").val("苏仙区测绘队");
        $("#myModal").modal('show');
    };
    //模态框隐藏时,处理是否取消上传，终止请求，查看是否有记录，有则删除
    /*
        readyState属性状态：
            0 代表未初始化。
            1 代表准备发送。
            2 已发送但还没收到响应
            3 正在接收
            4 接收完成
    */
    $(function () {
        $('#myModal').on('hide.bs.modal', function (e) {
            if (currentAjax) {
                if (currentAjax.readyState != 4) {
                    if (confirm("是否取消上传?")) {
                        console.log(currentAjax.readyState);
                        currentAjax.abort();
                        $(".progress-bar").css("width", "0%");
                        $(".progress-bar").html("");
                        //根据什么搜索记录是否存在呢？然后删除记录
                        //刷新数据
                        getDate(1, "", "");
                    }
                    else {
                        e.preventDefault();
                    }
                }
            }
        });
    });
    function submitInfo() {
        //声明对象
        var fileinfo = {
            FileName: "",
            Directory: "",
            CoodinateSystem: "",
            FinishtimeInfo: "",
            FinishPersonInfo: "",
            MinCoodinate: "",
            MaxCoodinate: "",
            ObjectNum: "",
            Mark: "",
            Warehousing: "",
            ProjectName: "",
            FileType: "",
            ProjectType: "",
            PcoodinateSystem: "",
            CenterMeridian: "",
            Yoffset: "",
            Xoffset: "",
            Finishtime: "",
            FinishPerson: "",
            SurveyingUnitName: "",
            Explain: "",
            PublicObjs: "",
            UploadTime: "",
            FileSize: "",
            UserID: ""
        };
        var directory = $("#input_file").val();
        if (directory == "")
            alert("没有选择文件！");
        else {
            var file = document.getElementById("input_file").files[0];
            if (file.size > 2147480000)//
            {
                alert("文件不得大于2GB!");
                return;
            }
            var arr = directory.split('\\');
            fileinfo.Directory = "";
            fileinfo.FileName = arr[arr.length - 1];
            var obj = $("#CoodinateSystem");
            fileinfo.CoodinateSystem = $("#CoodinateSystem").val();
            fileinfo.FinishtimeInfo = $("#finishtimeinfo").val();
            fileinfo.FinishPersonInfo = $("#finishpersoninfo").val();
            fileinfo.MinCoodinate = $("#mincoodinate").val();
            fileinfo.MaxCoodinate = $("#maxcoodinate").val();
            fileinfo.ObjectNum = $("#objectnum").val();
            fileinfo.Mark = $("#mark").val();
            fileinfo.Warehousing = $("input[name=Warehousing]:checked").val();
            fileinfo.ProjectName = $("#projectname").val();
            fileinfo.FileType = $("#filetype").val();
            fileinfo.ProjectType = $("#projecttype").val();
            fileinfo.PcoodinateSystem = $("#pcoodinateSystem").val();
            fileinfo.CenterMeridian = $("#centermeridian").val();
            fileinfo.Yoffset = $("#yoffset").val();
            fileinfo.Xoffset = $("#xoffset").val();
            fileinfo.Finishtime = $("#finishtime").val();
            fileinfo.FinishPerson = $("#finishperson").val();
            fileinfo.SurveyingUnitName = $("#surveyingunitname").val();
            fileinfo.Explain = $("#explain").val();
            var objarr = $("#selectObjs").val();
            fileinfo.PublicObjs = "";
            if (objarr != null)
            {
                for (var i = 0; i < objarr.length; i++) {
                    var text = objarr[i];
                    if (i > 0)
                        text = "|" + objarr[i];
                    fileinfo.PublicObjs += text;
                }
            }
            fileinfo.UploadTime = "";
            fileinfo.FileSize = file.size / 1024 / 1024;
            fileinfo.UserID = "0";
            //获取文件信息
            var formData = new FormData();
            formData.append("file", file);
            formData.append("fileinfo", JSON.stringify(fileinfo));
            currentAjax = $.ajax({
                url: "/FileManager/UpLoadFile",
                type: "post",
                // Form数据
                data: formData,
                dataType: "text",
                processData: false,
                //Options to tell JQuery not to process data or worry about content-type
                contentType: false,
                xhr: function () {
                    var xhr = $.ajaxSettings.xhr();
                    console.log(xhr.status);
                    if (onmyprogress && xhr.upload) {
                        xhr.upload.addEventListener("progress", onmyprogress, false);
                        return xhr;
                    }
                },
                success: function (data) {
                    $(".progress-bar").css("width", "100%");
                    $(".progress-bar").html("100%");
                    $("#myModal").modal('hide');
                    getDate(1, "", "");
                    console.log("=====" + data +"======");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (textStatus != "abort")
                    {
                        alert("上传失败！");
                        $("#myModal").modal('hide');
                    }
                    console.log(textStatus);
                }
            });
        }
    };
    //进度条事件
    /**
      * 侦查附件上传情况 ,这个方法大概0.05-0.1秒执行一次
      */
    function onmyprogress(evt) {
        var loaded = evt.loaded;     //已经上传大小情况
        var tot = evt.total;      //附件总大小
        var per = Math.floor(100 * loaded / tot);  //已经上传的百分比
        if (per == 100)
            per = 99;
        console.log(per + "%");
        $(".progress-bar").css("width", per + "%");
        $(".progress-bar").html(per + "%");
    }
    //点击文件管理标题
    $("#h-file").click(function () {
        //加载动画
        var divlist = $("#divlist-file");
        var d = divlist.css("display");
        if (d == "none") {
            $("#li-div-ul").html("");
            $("#card-file").css("display", "block");
            //加载分类
            $.ajax({
                url: "/FileManager/GetSelectedCategory",
                type: "get",
                dataType: "json",
                async: false,
                success: function (data) {
                    for (var i = 0; i < data.length; i++) {
                        var text = "<li><a class='classheader' onclick= 'clickheader(this)'>" + data[i].kind + "</a><ul class='subclass' style='display:none'><li>";
                        for (var j = 0; j < data[i].nodes.length; j++) {
                            text += "<a>" + data[i].nodes[j] + "</a>";
                        }
                        text += "</li></ul ></li >";
                        $("#li-div-ul").append(text);
                    }
                }
            });
            $("#divlist-file").css("display", "block");
            $("#card-file").css("display", "none");
        }
        else {
            divlist.css("display", "none");
        }
    });
    //点击地图管理标题
    $("#h-map").click(function () {
        //加载地图
        window.location.assign("/Home/MapManager");
    });
    //点击父分类
    function clickheader(e) {
        var next = $(e).next();
        var display = next.css("display");
        if (display == "none") {
            // $(e).css("background-color", "grey");
            next.css("display", "block");
        }
        else {
            //$(e).css("background-color", "white");
            next.css("display", "none");
        }
    };

    //获取数据
    function getDate(pageIndex, category, keywords) {
        $("#loading").css("display", "block");
        //获取文件数据
        $.ajax({
            url: 'GetFileView',
            type: "get",
            dataType: "html",
            data: { category: category, pageIndex: pageIndex, keywords: keywords },
            async: false,
            success: function (data) {
                //这里是ajax提交成功后，程序返回的数据处理函数。data是返回的数据，数据类型在dataType参数里定义！
                $("#div-filemanager").html(data);
                $("#loading").css("display", "none");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(textStatus);
                $("#loading").css("display", "none");
            }
        });
        var imgnum = $(".table").find("img").length;
        //重新记录选择效果
        var str = sessionStorage.getItem('selectimg');
        if (str != null)
        {
            var arr = JSON.parse(str);
            for (var i = 0; i < arr.length; i++) {
                var id = arr[i];
                var img = $("#" + id).find("img")[0];
                if (img != undefined)
                {
                    imgnum--;
                    var selectedimg = img.src.replace("select.png", "selected.png");
                    img.src = selectedimg;
                }
            }
        }
        if(imgnum == 0)
        {
            //全选处于选择状态
            var img = $("#footer_left img")[0];
            var selectedimg = img.src.replace("select.png", "selected.png");
            img.src = selectedimg;
        }
    };
    //点击子分类
    function clickclass(e) {
        //获得分类名
        var kind = e.innerText;
        var pageIndex = 1;
        getDate(pageIndex, kind, "");
        //获取所有子分类，将点击的背景深色
        var a = $(".subclass").find("a");
        for (var i = 0; i < a.length; i++)
        {
            $(a[i]).removeClass("checked");
        }
        $(e).addClass("checked");
    };

    //选择
    function selectimg(e) {
        setselect(e);
    }
    //删除记录
    function deleterecord(e)
    {
        var arrold = JSON.parse(sessionStorage.getItem('selectimg'));
        var id = e.parentNode.parentNode.id;
        var index = arrold.indexOf(id);
        arrold.splice(index, 1);
        sessionStorage.clear();
        sessionStorage.setItem('selectimg', JSON.stringify(arrold));
    }
    //保存记录
    function saverecord(e)
    {
        //保存json
        var arrold = sessionStorage.getItem('selectimg');
        var td = e.parentNode;
        var arrnew = new Array();
        arrnew[0] = td.parentNode.id;
        if (arrold != null) {
            var jsonold = JSON.parse(arrold);
            ////判断是否存在，存在就不添加
            var index = -1;
            for (var i = 0; i < jsonold.length; i++) {
                if (jsonold[i] == arrnew[0]) {
                    index = i;
                }
            }
            if (index > -1) {
                //jsonold.splice(index, 1)
                sessionStorage.setItem('selectimg', JSON.stringify(jsonold));
            }
            else
                sessionStorage.setItem('selectimg', JSON.stringify(jsonold.concat(arrnew)));
        }
        else
            sessionStorage.setItem('selectimg', JSON.stringify(arrnew));
    }
    //设置选择效果
    function setselect(e)
    {
        var obj = $(e);
        var src = obj[0].src;
        var arr = src.split("/");
        var img = arr[arr.length - 1];

        if (img == "select.png") {
            saverecord(e);
            var selectedimg = src.replace("select.png", "selected.png");
            obj.attr('src', selectedimg);
        }
        else {
            deleterecord(e);
            var selectimg = src.replace("selected.png", "select.png");
            obj.attr('src', selectimg);
        }
    }
    //复选框选择
    function selectallimg(e)
    {
        //将当前页所有img换颜色
        var src = $(e)[0].src;
        var arr = src.split("/");
        var img = arr[arr.length - 1];
        var f = $(".table").find(".select_img");
        if (img == "select.png")
        {
            var selectedimg = src.replace("select.png", "selected.png");
            for (var i = 0; i < f.length; i++)
            {
                saverecord(f[i]);
                $(f[i]).attr('src', selectedimg);
            }
            $(e).attr('src', selectedimg);
        }
        else
        {
            var selectimg = src.replace("selected.png", "select.png");
            for (var i = 0; i < f.length; i++) {
                deleterecord(f[i]);
                $(f[i]).attr('src', selectimg);
            }
            $(e).attr('src', selectimg);
        }
    }
    //搜索
    function search() {
        var keywords = $(".search").val();
        var pageIndex = 1;
        getDate(pageIndex,"", keywords);
    }
    //翻页
    function refresh(pageIndex)
    {
        var a = $(".subclass").find(".checked")[0];
        var category = "";
        if (a != undefined)
        {
            category = a.innerText;
            if (category == undefined)
                category = "";
        }
        var keywords = $(".search").val();
        getDate(pageIndex, category, keywords);
    }
    //删除
    function deleteFile(fileId) {
        //获取文件名
        var obj = $("#" + fileId).children("#file_" + fileId)[0];
        var filename = obj.innerText;
        if (confirm("你确定要删除" + filename + "吗？")) {
            $.getJSON("/Home/Delete?fileId=" + Number(fileId), function (data) {
                console.log(data.code);
                if (data.code == 4)
                {
                    $("#" + fileId).remove();
                    getDate(1, "", "");
                }
                else {
                    alert("删除失败!");
                }
            });
        }
    };
    function deleteFiles()
    {
        //获取所有id
        var ids = JSON.parse(sessionStorage.getItem('selectimg'));
        if(ids != null)
        {
            if (ids != null) {
                if (confirm("你确定要删除所选" + ids.length + "个文件吗？"))
                {
                    $.ajax({
                        url: '/Home/Deletes',
                        type: "post",
                        dataType: "text",
                        data: JSON.stringify(ids),
                        async: false,
                        success: function (data) {
                            var arr = JSON.parse(data);
                            for (var i = 0; i < arr.length; i++) {
                                $("#" + arr[i]).remove();
                            }
                            getDate(1, "", "");
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert("删除失败!");
                        }
                    });
                }
            }
        }
    }
    function downloadFiles()
    {
        //获取所有id
        var ids = JSON.parse(sessionStorage.getItem('selectimg'));
        if (ids != null) {
            $.ajax({
                url: '/Home/Downloads',
                type: "post",
                dataType: "text",
                data: JSON.stringify(ids),
                async: false,
                success: function (data) {
                    var json = JSON.parse(data);
                    if (json.code == 4)
                        window.open(json.url);
                    else
                        alert("下载失败!");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("下载失败!");
                }
            });
        }
    }

</script>
